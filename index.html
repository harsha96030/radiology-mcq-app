<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Radiology MCQ App</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 2rem; max-width: 800px; }
    select, button { margin: 0.5rem 0; padding: 0.5rem; font-size: 1rem; }
    #question-container { margin-top: 1rem; }
    #progress { font-weight: bold; margin-bottom: 0.5rem; }
    #question-text { font-size: 1.2rem; margin-bottom: 0.5rem; }
    #question-image { max-width: 100%; height: auto; margin-bottom: 0.5rem; }
    .option { display: block; margin: 0.5rem 0; padding: 0.6rem; border: 1px solid #ccc; border-radius: 4px; cursor: pointer; }
    .option.correct { background-color: #c8e6c9; }
    .option.wrong { background-color: #ffcdd2; }
    #explanation { margin-top: 1rem; font-style: italic; }
    #nav-buttons { margin-top: 1rem; }
    #summary { margin-top: 2rem; font-size: 1.1rem; }
  </style>
</head>
<body>
  <h1>Radiology MCQ App</h1>

  <label for="topic-select">Topic:</label><br>
  <select id="topic-select" disabled><option value="">--Select Topic--</option></select><br>

  <label for="subtopic-select">Subtopic:</label><br>
  <select id="subtopic-select" disabled><option value="">--Select Subtopic--</option></select>

  <div id="question-container" hidden>
    <div id="progress"></div>
    <div id="question-text"></div>
    <img id="question-image" hidden alt="MCQ Image">
    <div id="options"></div>
    <div id="explanation" hidden></div>
    <div id="nav-buttons">
      <button id="prev-btn">Previous</button>
      <button id="next-btn">Next</button>
    </div>
  </div>

  <div id="summary" hidden></div>

  <script>
    var JSON_URL = 'https://script.google.com/macros/s/AKfycbxgz2MzjW8B7vtbEXXLUJSVFMyFzG_Du13s49SliUrDfsur3vafKH7_XyK74eaGuy2J/exec';

    var data = [];
    var questions = [];
    var currentIndex = 0;

    var topicSelect       = document.getElementById('topic-select');
    var subtopicSelect    = document.getElementById('subtopic-select');
    var questionContainer = document.getElementById('question-container');
    var progressEl        = document.getElementById('progress');
    var questionText      = document.getElementById('question-text');
    var questionImage     = document.getElementById('question-image');
    var optionsDiv        = document.getElementById('options');
    var explanationEl     = document.getElementById('explanation');
    var prevBtn           = document.getElementById('prev-btn');
    var nextBtn           = document.getElementById('next-btn');
    var summaryEl         = document.getElementById('summary');

    // Fetch MCQs
    fetch(JSON_URL)
      .then(function(res) { return res.json(); })
      .then(function(json) {
        data = json;
        initTopics();
      })
      .catch(function(err) { alert('Error loading MCQs: ' + err); });

    function initTopics() {
      var topicSet = {};
      data.forEach(function(item) { topicSet[item.Topic] = true; });
      Object.keys(topicSet).forEach(function(topic) {
        var opt = document.createElement('option');
        opt.value = topic;
        opt.textContent = topic;
        topicSelect.appendChild(opt);
      });
      topicSelect.disabled = false;
    }

    topicSelect.addEventListener('change', function() {
      subtopicSelect.innerHTML = '<option value="">--Select Subtopic--</option>';
      questionContainer.hidden = true;
      summaryEl.hidden = true;
      if (!topicSelect.value) {
        subtopicSelect.disabled = true;
        return;
      }
      var subs = data.filter(function(item) {
        return item.Topic === topicSelect.value;
      }).map(function(item) {
        return item.Subtopic;
      });
      var uniqueSubs = {};
      subs.forEach(function(sub) { uniqueSubs[sub] = true; });
      Object.keys(uniqueSubs).forEach(function(sub) {
        var opt = document.createElement('option');
        opt.value = sub;
        opt.textContent = sub;
        subtopicSelect.appendChild(opt);
      });
      subtopicSelect.disabled = false;
    });

    subtopicSelect.addEventListener('change', function() {
      if (!subtopicSelect.value) return;
      questions = data.filter(function(item) {
        return item.Subtopic === subtopicSelect.value;
      });
      currentIndex = 0;
      questions.forEach(function(q) { q.wasCorrect = false; });
      renderQuestion();
    });

    function renderQuestion() {
      var item = questions[currentIndex];
      questionContainer.hidden = false;
      summaryEl.hidden = true;

      progressEl.textContent   = 'Question ' + (currentIndex+1) + ' of ' + questions.length;
      questionText.textContent = item.Question;

      // Image detection and conversion
      var url = '';
      for (var key in item) {
        if (/image/i.test(key) && item[key]) {
          url = item[key];
          var match = url.match(/\/d\/([^\/]+)\//);
          if (match) {
            url = 'https://drive.google.com/uc?export=view&id=' + match[1];
          }
          break;
        }
      }
      if (url) {
        questionImage.src = url;
        questionImage.hidden = false;
        questionImage.onerror = function() {
          questionImage.hidden = true;
          var link = document.createElement('a');
          link.href = url;
          link.target = '_blank';
          link.textContent = 'Open Image in new tab';
          link.style.display = 'block';
          link.style.marginBottom = '1rem';
          questionImage.parentNode.insertBefore(link, questionImage.nextSibling);
        };
      } else {
        questionImage.hidden = true;
      }

      // Render options
      optionsDiv.innerHTML = '';
      explanationEl.hidden = true;
      prevBtn.disabled = (currentIndex === 0);
      nextBtn.disabled = true;
      var correctLabel = item.Answer.charAt(0).toUpperCase() === 'O' ? item.Answer : 'Option ' + item.Answer;

      ['Option A','Option B','Option C','Option D','Option E'].forEach(function(label) {
        if (item[label]) {
          var btn = document.createElement('button');
          btn.textContent = item[label];
          btn.className = 'option';
          btn.onclick = function() { selectOption(btn, item[label], item[correctLabel]); };
          optionsDiv.appendChild(btn);
        }
      });
    }

    function selectOption(btn, chosenText, correctText) {
      Array.prototype.forEach.call(optionsDiv.children, function(el) { el.disabled = true; });
      if (chosenText === correctText) {
        btn.classList.add('correct');
        questions[currentIndex].wasCorrect = true;
      } else {
        btn.classList.add('wrong');
        Array.prototype.forEach.call(optionsDiv.children, function(el) {
          if (el.textContent === correctText) el.classList.add('correct');
        });
      }
      explanationEl.textContent = questions[currentIndex].Explanation || '';
      explanationEl.hidden = false;
      nextBtn.disabled = false;
    }

    prevBtn.addEventListener('click', function() {
      if (currentIndex > 0) {
        currentIndex--;
        renderQuestion();
      }
    });

    nextBtn.addEventListener('click', function() {
      if (currentIndex < questions.length - 1) {
        currentIndex++;
        renderQuestion();
      } else {
        var correctCount = questions.filter(function(q) { return q.wasCorrect; }).length;
        questionContainer.hidden = true;
        summaryEl.innerHTML = '<h2>Completed</h2>' +
                              '<p>You answered <strong>' + correctCount + '/' + questions.length + '</strong> correctly.</p>';
        summaryEl.hidden = false;
      }
    });
  </script>
</body>
</html>

